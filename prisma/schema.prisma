generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CertificationDocument {
  id         String    @id @default(uuid())
  code       String
  name       String
  type       String
  version    String
  status     String
  nextReview DateTime?
  owner      String
  fileUrl    String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([code, version])
}

model ControlledDocument {
  id           String      @id @default(uuid())
  code         String
  name         String
  type         String
  version      String
  status       String
  nextReview   DateTime?
  owner        String?
  fileUrl      String?
  fileBase64   String?
  fileName     String?
  plantId      String?
  processId    String?
  subprocessId String?
  machineId    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  machine      Machine?    @relation(fields: [machineId], references: [id], onDelete: Cascade)
  plant        Plant?      @relation(fields: [plantId], references: [id], onDelete: Cascade)
  process      Process?    @relation(fields: [processId], references: [id], onDelete: Cascade)
  subprocess   Subprocess? @relation(fields: [subprocessId], references: [id], onDelete: Cascade)
}

model Machine {
  id                  String               @id @default(uuid())
  code                String
  name                String
  manufacturer        String?
  model               String?
  serial              String?
  availability        Float                @default(0)
  mtbf                Float                @default(0)
  mttr                Float                @default(0)
  totalOts            Int                  @default(0)
  openOts             Int                  @default(0)
  subprocessId        String?
  processId           String?
  controlledDocuments ControlledDocument[]
  process             Process?             @relation(fields: [processId], references: [id], onDelete: Cascade)
  subprocess          Subprocess?          @relation(fields: [subprocessId], references: [id], onDelete: Cascade)
  documents           MachineDocument[]
  workOrders          WorkOrder[]
}

model MachineDocument {
  id         String   @id @default(uuid())
  machineId  String
  name       String
  mimeType   String
  base64Data String?
  filePath   String?
  uploadedAt DateTime @default(now())
  machine    Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
}

model Plant {
  id                  String               @id @default(uuid())
  name                String
  description         String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  location            String?
  controlledDocuments ControlledDocument[]
  processes           Process[]
  workOrders          WorkOrder[]
}

model Procedure {
  id             String              @id @default(uuid())
  title          String
  description    String?
  reviewer       String?
  responsible    String?
  notifyEmail    Boolean             @default(false)
  notifyWhatsapp Boolean             @default(false)
  status         String              @default("active")
  processId      String?
  subprocessId   String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  process        Process?            @relation(fields: [processId], references: [id], onDelete: Cascade)
  subprocess     Subprocess?         @relation(fields: [subprocessId], references: [id], onDelete: Cascade)
  documents      ProcedureDocument[]
}

model ProcedureDocument {
  id          String                     @id @default(uuid())
  code        String
  name        String
  procedureId String
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  procedure   Procedure                  @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  versions    ProcedureDocumentVersion[]

  @@unique([procedureId, code])
}

model ProcedureDocumentVersion {
  id          String            @id @default(uuid())
  version     String
  fileUrl     String?
  uploadDate  DateTime          @default(now())
  renewalDate DateTime?
  status      String            @default("in_review")
  updatedBy   String?
  documentId  String
  fileBase64  String?
  fileName    String?
  document    ProcedureDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model Process {
  id                  String               @id @default(uuid())
  name                String
  plantId             String
  description         String?
  controlledDocuments ControlledDocument[]
  machines            Machine[]
  procedures          Procedure[]
  plant               Plant                @relation(fields: [plantId], references: [id], onDelete: Cascade)
  subprocesses        Subprocess[]
  workOrders          WorkOrder[]
}

model Subprocess {
  id                  String               @id @default(uuid())
  name                String
  processId           String
  description         String?
  controlledDocuments ControlledDocument[]
  machines            Machine[]
  procedures          Procedure[]
  process             Process              @relation(fields: [processId], references: [id], onDelete: Cascade)
  workOrders          WorkOrder[]
}

model TechnicalReport {
  id                 String    @id @default(uuid())
  inspections        String?
  measurements       String?
  diagnosis          String?
  aiMatch            AiMatch?
  rootCause          String?
  actions            String[]  @default([])
  otherActionDetail  String?
  supplies           String?
  preventiveMeasures String?
  workOrderId        String    @unique
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  workOrder          WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

model WorkOrder {
  id              String           @id @default(uuid())
  otNumber        String           @unique
  plantId         String?
  processId       String?
  subprocessId    String?
  machineId       String?
  plantName       String
  processName     String
  subprocessName  String
  machineCode     String
  machineName     String
  reportDate      DateTime
  detectorName    String
  shift           String
  requestType     String
  machineStatus   String
  description     String
  symptoms        String[]
  status          WorkOrderStatus
  assignedTo      String?
  slaTarget       DateTime
  startedAt       DateTime?
  closedAt        DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  technicalReport TechnicalReport?
  machine         Machine?         @relation(fields: [machineId], references: [id])
  plant           Plant?           @relation(fields: [plantId], references: [id])
  process         Process?         @relation(fields: [processId], references: [id])
  subprocess      Subprocess?      @relation(fields: [subprocessId], references: [id])
  aiData          WorkOrderAIData?
  logs            WorkOrderLog[]
}

model WorkOrderAIData {
  id                   String            @id @default(uuid())
  classification       String
  priority             WorkOrderPriority
  riskLevel            RiskLevel
  productionImpact     String
  qualityImpact        Boolean
  operatorInstructions String
  rootCauses           Json
  suggestedActions     String[]
  workOrderId          String            @unique
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  workOrder            WorkOrder         @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

model WorkOrderLog {
  id          String    @id @default(uuid())
  date        DateTime
  action      String
  user        String
  comment     String?
  workOrderId String
  createdAt   DateTime  @default(now())
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

model AIQuery {
  id            String   @id @default(uuid())
  question      String
  answer        String
  answerSummary String?
  sources       Json?
  userId        String?
  userName      String?
  plantId       String?
  processId     String?
  subprocessId  String?
  machineId     String?
  contextPath   String?
  createdAt     DateTime @default(now())
}

enum AiMatch {
  yes
  no
}

enum RiskLevel {
  Bajo
  Medio
  Alto
}

enum WorkOrderPriority {
  P1
  P2
  P3
}

enum WorkOrderStatus {
  unassigned
  assigned
  in_progress
  on_hold
  testing
  closed
  cancelled
}
